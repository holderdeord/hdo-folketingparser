#!/bin/sh

set -e

fetch() {
    url="$1"
    file="$url"
    case "$url" in
	*/)
	    file="${url}index.html"
	    ;;
	*/?*)
	    file=$(echo "$url" | sed s%/?%/index.html?%)
	    ;;
	*)
	    ;;
    esac
    if GET "http://$url" > "$file".new ; then
	mv "$file".new "$file"
    else
	return false
    fi
}

current_sessions() {
    grep id data.stortinget.no/sesjoner/index.html | \
	cut -d'<' -f2 | cut -d'>' -f2|sort -u
}

fetch data.stortinget.no/
fetch data.stortinget.no/dagensrepresentanter/
fetch data.stortinget.no/sesjoner/

for id in $(current_sessions); do
    fetch "data.stortinget.no/saker/?sesjonid=$id"
    fetch "data.stortinget.no/partier/?sesjonid=$id"
    echo got $id 
done

sakidwithvotes="48650 49355 49975 47553 50319 50705 40970 40971 48718 45513 48577 46647 46623 49366 47162 49978 47793 48141"
# The ones with votes in the beta data set.
for sakid in $sakidwithvotes; do
    echo "got votering for sakid=$sakid"
    fetch "data.stortinget.no/voteringer/?sakid=$sakid"
    for vid in $(GET "http://data.stortinget.no/voteringer/?sakid=$sakid" |grep '<votering_id>' |sed 's%.*id>\(.*\)</.*%\1%') ; do
	fetch "data.stortinget.no/voteringsresultat/?voteringid=$vid"
	echo "got voteringsresultat for sakid=$sakid voteringsid=$vid"
    done
done

# Remove "empty" XML files.
rm $(grep -l '<voteringsresultat_liste />' data.stortinget.no/voteringsresultat/index.html\?voteringid\=*)

today=$(date +%Y-%m-%d)
git commit -m "Inn med data fra $today." data.stortinget.no
